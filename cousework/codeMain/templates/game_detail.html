{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ game.name }} – GamingLibrary{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Заголовок і повернення -->
        <div class="mb-10">
            <h1 class="text-5xl font-bold text-white break-words">{{ game.name }}</h1>
            <a href="{% url 'home' %}" class="text-blue-400 hover:underline text-sm mt-4 inline-block">
                ← Повернутися на головну
            </a>
        </div>

        <!-- Ліва колонка -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="space-y-8">
                <!-- Обкладинка -->
                <div class="rounded-xl overflow-hidden shadow-2xl border border-gray-700">
                    <img src="{{ game.header_image|default:'https://via.placeholder.com/460x215?text=No+Image' }}"
                         alt="{{ game.name }} header" class="w-full object-cover h-auto">
                </div>

                <!-- Статистика гравців -->
                <div class="bg-gray-800/80 backdrop-blur-md rounded-xl p-6 border border-gray-700 space-y-6">
                    <h3 class="text-2xl font-bold text-white text-center mb-4">Гравців онлайн</h3>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="text-center">
                            <p class="text-4xl font-bold text-green-400">
                                {% if game.current %}{{ game.current|intcomma }}{% else %}—{% endif %}
                            </p>
                            <p class="text-gray-400 mt-1">Зараз грають</p>
                        </div>
                        <div class="text-center">
                            <p class="text-4xl font-bold text-yellow-400">
                                {% if game.peak_24h %}{{ game.peak_24h|intcomma }}{% else %}—{% endif %}
                            </p>
                            <p class="text-gray-400 mt-1">Пік за 24 години</p>
                        </div>
                        <div class="text-center">
                            <p class="text-4xl font-bold text-purple-400">
                                {% if game.all_time_peak %}{{ game.all_time_peak|intcomma }}{% else %}—{% endif %}
                            </p>
                            <p class="text-gray-400 mt-1">
                                {% if game.all_time_peak_date %}Рекорд {{ game.all_time_peak_date }}{% else %}Рекорд усіх часів{% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Права колонка -->
            <div class="lg:col-span-2 space-y-10">
                <!-- Інформація про гру -->
                <div class="bg-gray-800/80 backdrop-blur-md rounded-xl p-8 border border-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Інформація про гру</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg">
                        <div><p class="text-gray-400">Розробник</p><p class="text-white">{{ game.developer|default:"Невідомо" }}</p></div>
                        <div><p class="text-gray-400">Видавець</p><p class="text-white">{{ game.publisher|default:"Невідомо" }}</p></div>
                        <div><p class="text-gray-400">Жанри</p><p class="text-white">{{ game.genres|default:"Невідомо" }}</p></div>
                        <div><p class="text-gray-400">Дата виходу</p><p class="text-white">{{ game.release_date|default:"Невідомо" }}</p></div>
                        <div><p class="text-gray-400">Платформи</p><p class="text-white">{{ game.platforms|default:"Невідомо" }}</p></div>
                        <div><p class="text-gray-400">Технології</p><p class="text-white">{{ game.technologies|default:"Не вказано" }}</p></div>
                    </div>
                </div>

                <!-- Графік -->
                <div class="bg-gray-800/80 backdrop-blur-md rounded-xl p-8 border border-gray-700">
                    <h3 class="text-2xl font-bold text-white text-center mb-6">Графік гравців (за 30 днів)</h3>
                    <div class="relative w-full h-96 mx-auto">
                        <canvas id="playerChart"></canvas>
                    </div>
                    <p class="text-gray-500 text-xs text-center mt-4">Джерело: SteamCharts API</p>
                </div>

                <!-- Блок відгуку -->
                {% if user.is_authenticated %}
                    <div class="bg-gray-800/80 backdrop-blur-md rounded-xl p-8 border border-gray-700">
                        <h2 class="text-2xl font-bold text-white text-center mb-8">Мій відгук</h2>

                        {% if has_review %}
                            <!-- Існуючий відгук -->
                            <div id="existing-review" class="bg-gray-700/50 rounded-xl p-6 space-y-6 mb-8">
                                {% if user_game.rating %}
                                    <div class="text-center">
                                        <p class="text-gray-400 mb-3">Оцінка</p>
                                        <div class="flex justify-center gap-2">
                                            {% for i in "12345" %}
                                                <svg class="w-12 h-12 {% if forloop.counter <= user_game.rating %}text-yellow-400 fill-yellow-400{% else %}text-gray-600 fill-gray-600{% endif %}"
                                                     viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                                </svg>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}

                                {% if user_game.status and user_game.status != 'not_played' %}
                                    <div class="text-center">
                                        <p class="text-gray-400 mb-2">Статус</p>
                                        <span class="inline-block px-6 py-3 rounded-full text-white font-bold text-lg
                                            {% if user_game.status == 'completed' %}bg-green-600
                                            {% elif user_game.status == 'playing' %}bg-blue-600
                                            {% elif user_game.status == 'dropped' %}bg-red-600{% endif %}">
                                            {{ user_game.get_status_display }}
                                        </span>
                                    </div>
                                {% endif %}

                                {% if user_game.comment %}
                                    <div>
                                        <p class="text-gray-400 mb-2">Коментар</p>
                                        <p class="text-white text-lg leading-relaxed bg-gray-800/50 rounded-lg p-4">{{ user_game.comment }}</p>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Кнопки дії -->
                            <div id="review-actions" class="flex justify-center gap-6 mb-8">
                                <button id="edit-button"
                                        class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition">
                                    Редагувати відгук
                                </button>
                                <form method="post" action="{% url 'delete_game_status' game.appid %}" class="inline">
                                    {% csrf_token %}
                                    <button type="submit"
                                            onclick="return confirm('Ви впевнені, що хочете видалити свій відгук?')"
                                            class="px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition">
                                        Видалити відгук
                                    </button>
                                </form>
                            </div>
                        {% endif %}

                        <!-- Форма (прихована, якщо відгук є) -->
                        <div id="review-form" class="{% if has_review %}hidden{% endif %}">
                            <form method="post" action="{% url 'update_game_status' game.appid %}">
                                {% csrf_token %}

                                <!-- Оцінка -->
                                <div class="mb-10">
                                    <label class="block text-gray-300 text-lg text-center mb-6">Моя оцінка</label>
                                    <div class="flex items-center justify-center gap-4" id="rating-stars">
                                        {% for i in "12345" %}
                                            <label class="cursor-pointer group">
                                                <input type="radio" name="rating" value="{{ forloop.counter }}"
                                                       {% if user_game.rating == forloop.counter %}checked{% endif %}
                                                       class="hidden">
                                                <svg class="w-14 h-14 transition-all duration-200 star
                                                    {% if user_game.rating >= forloop.counter %}text-yellow-400 fill-yellow-400{% else %}text-gray-600 fill-gray-600{% endif %}"
                                                     viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                                </svg>
                                            </label>
                                        {% endfor %}
                                        <label class="cursor-pointer ml-8">
                                            <input type="radio" name="rating" value="" {% if not user_game.rating %}checked{% endif %} class="hidden">
                                            <span class="text-gray-500 hover:text-gray-400 transition text-lg">Очистити</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Статус -->
                                <div class="mb-10">
                                    <label class="block text-gray-300 text-lg text-center mb-6">Статус проходження</label>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-2xl mx-auto" id="status-options">
                                        {% for value, label in status_choices %}
                                            <label class="cursor-pointer group">
                                                <input type="radio" name="status" value="{{ value }}"
                                                       {% if user_game.status == value %}checked{% endif %} class="hidden">
                                                <div class="border-2 border-gray-600 rounded-xl px-6 py-4 text-center transition-all duration-200 status-div
                                                    {% if user_game.status == value %}bg-blue-600 border-blue-500{% else %}bg-gray-700 hover:bg-gray-600{% endif %}">
                                                    <span class="text-white font-medium text-lg">{{ label }}</span>
                                                </div>
                                            </label>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Коментар -->
                                <div class="mb-10">
                                    <label for="comment" class="block text-gray-300 text-lg text-center mb-4">Коментар</label>
                                    <textarea id="comment" name="comment" rows="4"
                                              class="w-full px-6 py-4 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                                              placeholder="Поділіться своїми враженнями від гри...">{{ user_game.comment|default:'' }}</textarea>
                                </div>

                                <div class="text-center">
                                    <button type="submit"
                                            class="px-12 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold text-xl rounded-xl transition shadow-lg transform hover:scale-105">
                                        {% if has_review %}Зберегти зміни{% else %}Залишити відгук{% endif %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <div class="bg-gray-800/80 backdrop-blur-md rounded-xl p-12 border border-gray-700 text-center">
                        <p class="text-2xl text-gray-400">
                            <a href="{% url 'social:begin' 'steam' %}" class="text-blue-400 hover:underline font-bold">
                                Увійдіть через Steam
                            </a>, щоб залишити відгук
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Графік
            const ctx = document.getElementById('playerChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: {{ chart_data.labels|safe }},
                    datasets: [{
                        label: 'Кількість гравців',
                        data: {{ chart_data.data|safe }},
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#3b82f6',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#9ca3af', maxTicksLimit: 12 }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Кнопка редагування
            const editButton = document.getElementById('edit-button');
            if (editButton) {
                editButton.addEventListener('click', () => {
                    document.getElementById('existing-review').classList.add('hidden');
                    document.getElementById('review-actions').classList.add('hidden');
                    document.getElementById('review-form').classList.remove('hidden');
                });
            }

            // Інтерактивність зірок
            const stars = document.querySelectorAll('#rating-stars .star');
            document.querySelectorAll('#rating-stars input[type="radio"]').forEach((input, idx) => {
                input.addEventListener('change', () => {
                    stars.forEach((star, i) => {
                        if (i <= idx) {
                            star.classList.add('text-yellow-400', 'fill-yellow-400');
                            star.classList.remove('text-gray-600', 'fill-gray-600');
                        } else {
                            star.classList.remove('text-yellow-400', 'fill-yellow-400');
                            star.classList.add('text-gray-600', 'fill-gray-600');
                        }
                    });
                });
            });

            // Інтерактивність статусів
            document.querySelectorAll('#status-options input[type="radio"]').forEach((input, idx) => {
                input.addEventListener('change', () => {
                    document.querySelectorAll('#status-options .status-div').forEach(div => {
                        div.classList.remove('bg-blue-600', 'border-blue-500');
                        div.classList.add('bg-gray-700', 'hover:bg-gray-600');
                    });
                    document.querySelectorAll('#status-options .status-div')[idx].classList.add('bg-blue-600', 'border-blue-500');
                    document.querySelectorAll('#status-options .status-div')[idx].classList.remove('bg-gray-700', 'hover:bg-gray-600');
                });
            });
        });
    </script>
{% endblock %}