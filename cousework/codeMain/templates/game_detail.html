{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ game.name }} – Ігрова Бібліотека{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
        <!-- Заголовок та повернення -->
        <div class="mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight break-words">
                {{ game.name }}
            </h1>
            <a href="{% url 'home' %}"
               class="mt-4 inline-flex items-center text-blue-400 hover:text-blue-300 transition">
                ← Повернутися на головну
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
            <!-- Ліва колонка: обкладинка + основна інформація -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Головне зображення -->
                <div class="rounded-2xl overflow-hidden shadow-2xl border border-gray-700/50 bg-gray-900">
                    <img
                            src="{{ game.background_image|default:'https://via.placeholder.com/460x215?text=Немає+зображення' }}"
                            alt="{{ game.name }}"
                            class="w-full h-auto object-cover"
                            loading="lazy"
                    >
                </div>

                <!-- Коротка інформація про гру -->
                <div class="bg-gray-800/70 backdrop-blur-sm rounded-2xl p-6 border border-gray-700/50">
                    <h3 class="text-xl font-semibold text-white mb-5">Про гру</h3>
                    <dl class="space-y-4 text-sm">
                        {% if game.released %}
                            <div class="flex justify-between">
                                <dt class="text-gray-400">Дата виходу</dt>
                                <dd class="text-white font-medium">{{ game.released|date:"d.m.Y"|default:"Невідомо" }}</dd>
                            </div>
                        {% endif %}

                        {% if game.genres %}
                            <div class="flex justify-between">
                                <dt class="text-gray-400">Жанри</dt>
                                <dd class="text-white font-medium">{{ game.genres }}</dd>
                            </div>
                        {% endif %}

                        {% if game.platforms %}
                            <div class="flex justify-between">
                                <dt class="text-gray-400">Платформи</dt>
                                <dd class="text-white font-medium">{{ game.platforms }}</dd>
                            </div>
                        {% endif %}

                        {% if game.developer %}
                            <div class="flex justify-between">
                                <dt class="text-gray-400">Розробник</dt>
                                <dd class="text-white font-medium">{{ game.developer|default:"Невідомо" }}</dd>
                            </div>
                        {% endif %}

                        {% if game.publisher %}
                            <div class="flex justify-between">
                                <dt class="text-gray-400">Видавець</dt>
                                <dd class="text-white font-medium">{{ game.publisher|default:"Невідомо" }}</dd>
                            </div>
                        {% endif %}

                        {% if game.metacritic %}
                            <div class="flex justify-between">
                                <dt class="text-gray-400">Metacritic</dt>
                                <dd class="text-white font-bold {% if game.metacritic >= 80 %}text-green-400{% elif game.metacritic >= 60 %}text-yellow-400{% else %}text-red-400{% endif %}">
                                    {{ game.metacritic }}/100
                                </dd>
                            </div>
                        {% endif %}

                        {% if game.rating %}
                            <div class="flex justify-between">
                                <dt class="text-gray-400">Оцінка RAWG</dt>
                                <dd class="text-white font-bold text-purple-400">
                                    {{ game.rating|floatformat:1 }}/5
                                </dd>
                            </div>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Права колонка: опис + відгук + відгуки друзів -->
            <div class="lg:col-span-2 space-y-10">
                <!-- Опис гри -->
                {% if game.description %}
                    <div class="bg-gray-800/70 backdrop-blur-sm rounded-2xl p-7 lg:p-9 border border-gray-700/50 prose prose-invert max-w-none">
                        <h2 class="text-2xl md:text-3xl font-bold text-white mb-6">Про гру</h2>
                        <div class="text-gray-200 leading-relaxed">
                            {{ game.description|safe|linebreaksbr }}
                        </div>
                    </div>
                {% endif %}

                <!-- Блок мого відгуку -->
                <!-- Блок мого відгуку -->
                {% if user.is_authenticated %}
                    <div class="bg-gray-800/70 backdrop-blur-sm rounded-2xl p-7 lg:p-9 border border-gray-700/50">
                        <h2 class="text-2xl md:text-3xl font-bold text-white mb-8 text-center">Мій відгук</h2>

                        {% if has_review %}
                            <!-- Показуємо існуючий відгук -->
                            <div id="existing-review" class="space-y-8 mb-10">
                                {% if user_game.rating %}
                                    <div class="text-center">
                                        <p class="text-gray-400 mb-3">Моя оцінка</p>
                                        <div class="flex justify-center gap-2">
                                            {% for i in "12345" %}
                                                <svg class="w-10 h-10 {% if forloop.counter <= user_game.rating %}text-yellow-400 fill-current{% else %}text-gray-600{% endif %}"
                                                     viewBox="0 0 24 24">
                                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                                </svg>
                                            {% endfor %}
                                        </div>
                                        <p class="text-gray-400 mt-2 text-sm">({{ user_game.rating }}/5)</p>
                                    </div>
                                {% endif %}

                                {% if user_game.status and user_game.status != 'not_played' %}
                                    <div class="text-center">
                                        <p class="text-gray-400 mb-2">Статус</p>
                                        <span class="inline-block px-8 py-3 rounded-full text-lg font-bold
                {% if user_game.status == 'completed' %}bg-green-600
                {% elif user_game.status == 'playing' %}bg-blue-600
                {% elif user_game.status == 'planned' %}bg-purple-600
                {% elif user_game.status == 'dropped' %}bg-red-600{% endif %}">
                {{ user_game.get_status_display }}
            </span>
                                    </div>
                                {% endif %}

                                {% if user_game.comment %}
                                    <div class="bg-gray-900/50 rounded-xl p-6">
                                        <p class="text-gray-400 mb-3">Коментар</p>
                                        <p class="text-gray-200 whitespace-pre-wrap leading-relaxed">
                                            {{ user_game.comment }}
                                        </p>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Кнопки редагувати / видалити -->
                            <div id="review-actions" class="flex justify-center gap-6">
                                <button id="edit-button"
                                        class="px-10 py-4 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold transition transform hover:scale-105">
                                    Редагувати
                                </button>
                                <form method="post" action="{% url 'delete_game_status' game.rawg_id %}" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" onclick="return confirm('Видалити свій відгук?')"
                                            class="px-10 py-4 bg-red-600 hover:bg-red-700 rounded-xl font-bold transition transform hover:scale-105">
                                        Видалити
                                    </button>
                                </form>
                            </div>
                        {% endif %}

                        <!-- Форма створення/редагування відгуку -->
                        <div id="review-form" class="{% if has_review %}hidden{% endif %} mt-10">
                            <form method="post" action="{% url 'update_game_status' game.rawg_id %}">
                                {% csrf_token %}

                                <!-- Блок оцінки -->
                                <div id="rating-block"
                                     class="mb-10 {% if user_game.status == 'planned' %}hidden{% endif %}">
                                    <label class="block text-gray-300 text-lg text-center mb-6">Моя оцінка</label>
                                    <div class="flex items-center justify-center gap-3" id="rating-stars">
                                        {% for i in "12345" %}
                                            <label class="cursor-pointer group">
                                                <input type="radio" name="rating" value="{{ forloop.counter }}"
                                                       {% if user_game.rating == forloop.counter %}checked{% endif %}
                                                       class="hidden">
                                                <svg class="w-16 h-16 transition-all duration-200 star {% if user_game.rating >= forloop.counter %}text-yellow-400 fill-current{% else %}text-gray-600{% endif %}"
                                                     viewBox="0 0 24 24">
                                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                                </svg>
                                            </label>
                                        {% endfor %}
                                        <label class="cursor-pointer ml-10">
                                            <input type="radio" name="rating" value=""
                                                   {% if not user_game.rating %}checked{% endif %} class="hidden">
                                            <span class="text-gray-500 hover:text-gray-400 transition text-lg">Без оцінки</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Повідомлення для статусу "У планах" -->
                                <div id="planned-message"
                                     class="text-center text-gray-500 mt-4 text-sm mb-10 {% if user_game.status != 'planned' %}hidden{% endif %}">
                                    Оцінку можна поставити тільки після початку гри або проходження
                                </div>

                                <!-- Вибір статусу -->
                                <div class="mb-10">
                                    <label class="block text-gray-300 text-lg text-center mb-6">Статус
                                        проходження</label>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-2xl mx-auto"
                                         id="status-options">
                                        {% for value, label in status_choices %}
                                            <label class="cursor-pointer group">
                                                <input type="radio" name="status" value="{{ value }}"
                                                       {% if user_game.status == value %}checked{% endif %}
                                                       class="hidden">
                                                <div class="border-2 border-gray-600 rounded-xl px-6 py-4 text-center transition-all duration-200 status-div
                            {% if user_game.status == value %}
                                {% if value == 'playing' %}bg-blue-600 border-blue-500
                                {% elif value == 'completed' %}bg-green-600 border-green-500
                                {% elif value == 'planned' %}bg-purple-600 border-purple-500
                                {% elif value == 'dropped' %}bg-red-600 border-red-500
                                {% else %}bg-gray-700 border-gray-500{% endif %}
                            {% else %}
                                bg-gray-700 hover:bg-gray-600
                            {% endif %}">
                                                    <span class="text-white font-medium text-lg">{{ label }}</span>
                                                </div>
                                            </label>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Коментар -->
                                <div class="mb-10">
                                    <label for="comment"
                                           class="block text-gray-300 text-lg text-center mb-4">Коментар</label>
                                    <textarea id="comment" name="comment" rows="4"
                                              class="w-full px-6 py-4 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                                              placeholder="Поділіться своїми враженнями від гри...">{{ user_game.comment|default:'' }}</textarea>
                                </div>

                                <!-- Додавання до списку -->
                                <div class="mb-10">
                                    <label class="block text-gray-300 text-lg text-center mb-4">Додати до списку</label>
                                    <select name="list_id"
                                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Не додавати</option>
                                        {% for lst in user.lists.all %}
                                            <option value="{{ lst.id }}">{{ lst.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="text" name="new_list" placeholder="Створити новий список..."
                                           class="mt-4 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <!-- Кнопка збереження -->
                                <div class="text-center">
                                    <button type="submit"
                                            class="px-12 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold text-xl rounded-xl transition shadow-lg transform hover:scale-105">
                                        {% if has_review %}Зберегти зміни{% else %}Залишити відгук{% endif %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <div class="bg-gray-800/70 backdrop-blur-sm rounded-2xl p-12 border border-gray-700/50 text-center">
                        <p class="text-xl text-gray-300">
                            <a href="{% url 'login' %}" class="text-blue-400 font-bold hover:underline">
                                Увійдіть
                            </a>, щоб залишити відгук та статус
                        </p>
                    </div>
                {% endif %}

                <!-- Відгуки друзів -->
                {% if friends_reviews %}
                    <div class="bg-gray-800/70 backdrop-blur-sm rounded-2xl p-7 lg:p-9 border border-gray-700/50">
                        <h2 class="text-2xl md:text-3xl font-bold text-white mb-8 text-center">Відгуки друзів</h2>
                        <div class="space-y-8">
                            {% for review in friends_reviews %}
                                <div class="bg-gray-900/40 rounded-xl p-6">
                                    <div class="flex items-center gap-4 mb-4">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">
                                            {{ review.user.username|slice:":1"|upper }}
                                        </div>
                                        <div>
                                            <p class="text-white font-medium">{{ review.user.username }}</p>
                                            <p class="text-gray-500 text-sm">{{ review.updated_at|date:"d.m.Y H:i" }}</p>
                                        </div>
                                    </div>

                                    {% if review.rating %}
                                        <div class="mb-4">
                                            <div class="flex gap-1">
                                                {% for i in "12345" %}
                                                    <svg class="w-7 h-7 {% if forloop.counter <= review.rating %}text-yellow-400 fill-current{% else %}text-gray-700{% endif %}"
                                                         viewBox="0 0 24 24">
                                                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                                    </svg>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if review.comment %}
                                        <p class="text-gray-200 leading-relaxed">
                                            {{ review.comment }}
                                        </p>
                                    {% endif %}
                                </div>
                            {% empty %}
                                <p class="text-center text-gray-400 py-8">Ваші друзі ще не оцінювали цю гру</p>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Chart.js + JS для інтерактивності -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Графік гравців


            // Редагування відгуку
            const editButton = document.getElementById('edit-button');
            if (editButton) {
                editButton.addEventListener('click', () => {
                    document.getElementById('existing-review')?.classList.add('hidden');
                    document.getElementById('review-actions')?.classList.add('hidden');
                    document.getElementById('review-form')?.classList.remove('hidden');
                });
            }

            // Інтерактивність зірок
            const starsContainer = document.getElementById('rating-stars');
            if (starsContainer) {
                const stars = starsContainer.querySelectorAll('.star');
                const inputs = starsContainer.querySelectorAll('input[type="radio"]');

                inputs.forEach((input, idx) => {
                    input.addEventListener('change', () => {
                        stars.forEach((star, i) => {
                            if (i <= idx) {
                                star.classList.add('text-yellow-400', 'fill-yellow-400');
                                star.classList.remove('text-gray-600', 'fill-gray-600');
                            } else {
                                star.classList.remove('text-yellow-400', 'fill-yellow-400');
                                star.classList.add('text-gray-600', 'fill-gray-600');
                            }
                        });
                    });
                });
            }

            // Інтерактивність статусів
            const statusOptions = document.getElementById('status-options');
            if (statusOptions) {
                const inputs = statusOptions.querySelectorAll('input[type="radio"]');
                const divs = statusOptions.querySelectorAll('.status-div');

                inputs.forEach((input, idx) => {
                    input.addEventListener('change', () => {
                        divs.forEach(div => {
                            div.classList.remove('bg-blue-600', 'border-blue-500', 'bg-green-600', 'border-green-500',
                                'bg-purple-600', 'border-purple-500', 'bg-red-600', 'border-red-500');
                            div.classList.add('bg-gray-700', 'hover:bg-gray-600');
                        });

                        const selectedDiv = divs[idx];
                        const value = input.value;
                        if (value === 'playing') selectedDiv.classList.add('bg-blue-600', 'border-blue-500');
                        else if (value === 'completed') selectedDiv.classList.add('bg-green-600', 'border-green-500');
                        else if (value === 'planned') selectedDiv.classList.add('bg-purple-600', 'border-purple-500');
                        else if (value === 'dropped') selectedDiv.classList.add('bg-red-600', 'border-red-500');

                        selectedDiv.classList.remove('bg-gray-700', 'hover:bg-gray-600');

                        const ratingBlock = document.getElementById('rating-block');
                        const plannedMessage = document.getElementById('planned-message');

                        if (value === 'planned') {
                            ratingBlock?.classList.add('hidden');
                            plannedMessage?.classList.remove('hidden');
                            inputs.forEach(r => {
                                if (r.name === 'rating') r.checked = false;
                            });
                        } else {
                            ratingBlock?.classList.remove('hidden');
                            plannedMessage?.classList.add('hidden');
                        }
                    });
                });

                // Початкова ініціалізація
                const initialChecked = statusOptions.querySelector('input[type="radio"]:checked');
                if (initialChecked && initialChecked.value === 'planned') {
                    document.getElementById('rating-block')?.classList.add('hidden');
                    document.getElementById('planned-message')?.classList.remove('hidden');
                }
            }
        });
    </script>
{% endblock %}